apiVersion: v1
kind: ConfigMap
metadata:
  name: xrootd-http-config
  namespace: xrootd
data:
  xrootd-http.cfg: |
    ###########################################################################
    # This is a very simple sample configuration file sufficient to start an  #
    # xrootd data server using the default port 1094 plus http protocol on    #
    # port 80. This server runs by itself (stand-alone) and does not assume   #
    # it is part of a cluster. You can then connect to this server to access  #
    # files in '/tmp'. Consult the the reference manuals on how to create     #
    # more complicated configurations and set the host cert and key for http. #
    #                                                                         #
    # On successful start-up you will see 'initialization completed' in the   #
    # last message. You can now connect to the xrootd server.                 #
    #                                                                         #
    # Note: You should always create a *single* configuration file for all    #
    # daemons related to xrootd.                                              #
    ###########################################################################

    # The export directive indicates which paths are to be exported. While the
    # default is '/tmp', we indicate it anyway to show you this directive.
    #
    #all.export /tmp
    all.export /data

    # The adminpath and pidpath variables indicate where the pid and various
    # IPC files should be placed
    #
    all.adminpath /var/spool/xrootd
    all.pidpath /run/xrootd

    # Load the http protocol, indicate that it should be served on port 80.
    # The socket bound to port 80 has to be preallocated by the systemd
    # xrdhttp.socket (requires systemd!).
    #
    # In order to enable the xrdhttp.socket run:
    #	systemctl enable xrdhttp@http.socket
    # In order to start the xrdhttp.socket run:
    #	systemctl start xrdhttp@http.socket
    #
    xrd.protocol XrdHttp:80 libXrdHttp.so
    # More configuration files can be added in /etc/xrootd/config.d/
    # For example /etc/xrootd/config.d/10-mygrid.cfg and
    # /etc/xrootd/config.d/98-mysite-specifics.cfg
    #
    # Config TLS
    xrd.tls /etc/grid-security/xrd/tls.crt /etc/grid-security/xrd/tls.key
    xrd.tlsca certdir /etc/grid-security/certificates refresh 8h
    xrootd.tls capable all -data
  
    # Config tokens
    xrootd.seclib libXrdSec.so
    sec.level all compatible

    # More configuration files can be added in /etc/xrootd/config.d/
    # For example /etc/xrootd/config.d/10-mygrid.cfg and
    # /etc/xrootd/config.d/98-mysite-specifics.cfg

    # Authentication and Authorisation part
    ofs.authorize 1
    ofs.authlib ++ libXrdAccSciTokens.so config=/etc/xrootd/scitokens.cfg
    ofs.authlib ++ libXrdMacaroons.so
    acc.authdb /etc/xrootd/Authfile
    acc.audit deny
    acc.authrefresh 60

    # Pass the bearer token to the Xrootd authorization framework.
    http.header2cgi Authorization authz

    # Only for debugging (comment out after setup is done)
    scitokens.trace all
    ofs.trace all
    pfc.trace all
    xrd.trace all -sched
    pss.setopt DebugLevel 5

    all.sitename CHSRC-RSE

    # Enable third-party-copy
    http.exthandler xrdtpc libXrdHttpTPC.so
  scitokens.cfg: |
    [Global]
    onmissing = passthrough

    [Issuer ESCAPE IAM]
    issuer =  https://iam-escape.cloud.cnaf.infn.it/
    base_path = /data
    map_subject = false
    default_user = xrootd

    [Issuer SKA-IAM]
    issuer = https://ska-iam.stfc.ac.uk/
    base_path = /data
    map_subject = false
    default_user = xrootd

  Authfile: |
    # Grant access to all directories below '/data/'
    g * /data a
